# 部署流程

本文档详细介绍了WFWK应用的部署流程，包括测试环境和生产环境的部署步骤。

## 部署前准备

### 1. 环境检查

确保目标服务器满足以下要求：
- 操作系统: Ubuntu 20.04+ 或 CentOS 8+
- 内存: 至少16GB RAM
- 存储空间: 至少50GB可用空间
- Docker和Docker Compose已安装

### 2. 代码准备

确保代码已经过充分测试，并且版本标签已创建：
```bash
git tag v1.2.3
git push origin v1.2.3
```

### 3. 配置文件

准备目标环境的配置文件：
- `.env.production`: 生产环境配置
- `docker-compose.prod.yml`: 生产环境Docker配置

## 部署步骤

### 1. 测试环境部署

1. 克隆或更新代码:
   ```bash
   git clone https://github.com/your-organization/wfwk.git
   cd wfwk
   git checkout v1.2.3
   ```

2. 复制配置文件:
   ```bash
   cp .env.example .env.test
   # 根据测试环境修改配置
   ```

3. 构建Docker镜像:
   ```bash
   docker-compose -f docker-compose.test.yml build
   ```

4. 启动服务:
   ```bash
   docker-compose -f docker-compose.test.yml up -d
   ```

5. 运行数据库迁移:
   ```bash
   docker-compose -f docker-compose.test.yml exec backend npm run migrate
   ```

6. 验证部署:
   访问测试环境URL，确保所有功能正常。

### 2. 生产环境部署

1. 在生产服务器上克隆或更新代码:
   ```bash
   git clone https://github.com/your-organization/wfwk.git
   cd wfwk
   git checkout v1.2.3
   ```

2. 复制生产配置文件:
   ```bash
   cp .env.example .env.production
   # 根据生产环境修改配置
   ```

3. 停止当前服务:
   ```bash
   docker-compose -f docker-compose.prod.yml down
   ```

4. 备份数据库:
   ```bash
   pg_dump -h db-host -U db-user -d wfwk > backup-$(date +%Y%m%d).sql
   ```

5. 构建新的Docker镜像:
   ```bash
   docker-compose -f docker-compose.prod.yml build
   ```

6. 启动服务:
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

7. 运行数据库迁移:
   ```bash
   docker-compose -f docker-compose.prod.yml exec backend npm run migrate
   ```

8. 验证部署:
   访问生产环境URL，确保所有功能正常。

## 回滚流程

如果部署后发现问题，可以按照以下步骤回滚：

1. 停止当前服务:
   ```bash
   docker-compose -f docker-compose.prod.yml down
   ```

2. 切换到上一个版本:
   ```bash
   git checkout v1.2.2
   ```

3. 启动服务:
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

## 自动化部署

我们使用GitHub Actions实现CI/CD自动化部署：

1. 当代码推送到`main`分支时，自动部署到测试环境
2. 当创建新的release时，自动部署到生产环境

相关配置文件位于`.github/workflows/deploy.yml`。

## 监控和日志

部署完成后，确保以下监控和日志系统正常工作：

1. 应用日志可以通过Docker查看:
   ```bash
   docker-compose -f docker-compose.prod.yml logs -f
   ```

2. 系统监控通过Prometheus和Grafana实现
3. 错误跟踪通过Sentry实现

## 常见问题

### 1. 部署失败

检查Docker容器日志:
```bash
docker-compose -f docker-compose.prod.yml logs
```

### 2. 数据库连接失败

检查数据库配置和网络连接。

### 3. 性能问题

检查系统资源使用情况，必要时调整容器资源配置。